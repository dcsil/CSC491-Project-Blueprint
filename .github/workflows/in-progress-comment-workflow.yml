name: Comment on In Progress Issues

# This workflow runs on a schedule to check for issues moved to "In Progress"
# It also responds to webhook events for real-time updates
on:
  schedule:
    # Run every 5 minutes to check for project status changes
    - cron: '*/5 * * * *'
  workflow_dispatch: # Allow manual triggering
  repository_dispatch:
    types: [project_updated]

jobs:
  check-and-comment:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check project items and add comments
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = 'dcsil';
            const repo = 'csc491-w2026-templates';
            const projectNumber = 108;
            
            // GraphQL query to get all issues in the project
            const query = `
              query($owner: String!, $repo: String!, $projectNumber: Int!) {
                organization(login: $owner) {
                  projectV2(number: $projectNumber) {
                    id
                    title
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on Issue {
                            id
                            number
                            title
                            state
                            url
                          }
                        }
                        fieldValues(first: 20) {
                          nodes {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              field {
                                ... on ProjectV2FieldCommon {
                                  name
                                }
                              }
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const variables = {
              owner: owner,
              repo: repo,
              projectNumber: projectNumber
            };
            
            try {
              const result = await github.graphql(query, variables);
              const project = result.organization?.projectV2;
              
              if (!project) {
                console.log('Project not found');
                return;
              }
              
              console.log(`Checking ${project.items.nodes.length} items in project`);
              
              for (const item of project.items.nodes) {
                if (!item.content || item.content.__typename !== 'Issue') {
                  continue;
                }
                
                const issue = item.content;
                const issueNumber = issue.number;
                
                // Find the Status field
                const statusField = item.fieldValues?.nodes?.find(
                  field => {
                    const fieldName = field?.field?.name?.toLowerCase() || '';
                    return fieldName === 'status' || fieldName.includes('status');
                  }
                );
                
                if (!statusField) {
                  continue;
                }
                
                const statusValue = statusField.name || '';
                const isInProgress = statusValue.toLowerCase().includes('progress') || 
                                    statusValue === 'In Progress' ||
                                    statusValue.toLowerCase() === 'in progress';
                
                if (isInProgress && issue.state === 'OPEN') {
                  // Check if we've already commented on this issue
                  const comments = await github.rest.issues.listComments({
                    owner: owner,
                    repo: repo,
                    issue_number: issueNumber
                  });
                  
                  const hasBotComment = comments.data.some(comment => 
                    comment.body.includes('üöß **This issue is now in progress!**') &&
                    comment.user.type === 'Bot'
                  );
                  
                  if (!hasBotComment) {
                    const comment = `üöß **This issue is now in progress!** üöß
            
            Someone is working on this issue. Here are the action items to track progress:
            
            ## Action Items
            
            - [ ] Review and understand the issue requirements
            - [ ] Set up development environment if needed
            - [ ] Break down the work into smaller tasks
            - [ ] Create a branch for this work: \`git checkout -b issue-${issueNumber}\`
            - [ ] Implement the solution
            - [ ] Write/update tests
            - [ ] Update documentation if needed
            - [ ] Create pull request
            - [ ] Get code review approval
            - [ ] Merge and deploy
            
            ---
            *This comment was automatically added when the issue was moved to "In Progress" status.*
            `;
                    
                    await github.rest.issues.createComment({
                      owner: owner,
                      repo: repo,
                      issue_number: issueNumber,
                      body: comment
                    });
                    
                    console.log(`‚úÖ Added comment to issue #${issueNumber}: ${issue.title}`);
                  } else {
                    console.log(`‚è≠Ô∏è  Issue #${issueNumber} already has a comment`);
                  }
                }
                
                // If issue is closed but status is "In Progress", reopen it
                if (isInProgress && issue.state === 'CLOSED') {
                  await github.rest.issues.update({
                    owner: owner,
                    repo: repo,
                    issue_number: issueNumber,
                    state: 'open'
                  });
                  console.log(`üîÑ Reopened issue #${issueNumber} that was incorrectly closed`);
                }
              }
            } catch (error) {
              console.error('Error checking project:', error);
              throw error;
            }
